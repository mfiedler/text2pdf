#!/bin/bash
# Converts ASCII text files to PostScript

set -o errexit
# debugging
#set -x

A2PS_ARGS="--tabsize=4 \
           --portrait \
           --highlight-level=heavy \
           --prologue=color \
           --columns=1 \
           --rows=1 \
           --font-size=11 \
           --media=A4 \
           --chars-per-line=80 \
           --line-numbers=1 \
           --encoding=ASCII
           --quiet"
FIRST_ARG="$1"
SECOND_ARG="$2"
INPUT_FILE="${FIRST_ARG}"
OUTPUT_FILE="${SECOND_ARG}"

EXIT_SUCCESS=0
EXIT_ERROR=1
EXIT_BADARGS=2


function print_usage()
{
	echo "Usage: text2ps [ input_file | - ] [ output_file | - ]"
    echo 
    echo "Note: 'text2ps -' is treated as an alias for 'text2ps - -'"
}


# --help
if [ "${FIRST_ARG}" = "--help" ]
then
    print_usage
    exit ${EXIT_SUCCESS}
fi


# wrong number of args?
if [ "$#" = 0 ] || [ "$#" -ge 3 ]
then
	echo "Invalid number of arguments."
    echo
    print_usage
    exit ${EXIT_BADARGS}
fi

if [ ! "${INPUT_FILE}" = "-" ]
then
    # check input file
    if [ ! -e "${INPUT_FILE}" ]
    then
        echo "${INPUT_FILE}: file does not exist"
        exit ${EXIT_BADARGS}
    fi
    if [ ! -f "${INPUT_FILE}" ]
    then
        echo "${INPUT_FILE}: not a regular file"
        exit ${EXIT_BADARGS}
    fi
    if [ ! -r "${INPUT_FILE}" ]
    then
        echo "${INPUT_FILE}: no read permission"
        exit ${EXIT_BADARGS}
    fi
    if [ ! -s "${INPUT_FILE}" ]
    then
        echo "${INPUT_FILE}: file is empty"
        exit ${EXIT_BADARGS}
    fi
    
    if [ "$#" = 1 ]
    then
        OUTPUT_FILE="${INPUT_FILE}.ps"
    fi
else
    # Files called '-.ps' are not nice, so we use stdout
    if [ "$#" = 1 ]
    then
        OUTPUT_FILE="-"
    fi
fi

if [ ! "${OUTPUT_FILE}" = "-" ]
then
    if [ ! -w "${OUTPUT_FILE}" ]
    then
        echo "${OUTPUT_FILE}: no write permission"
        exit ${EXIT_BADARGS}
    fi
fi

a2ps ${A2PS_ARGS} --output="${OUTPUT_FILE}" "${INPUT_FILE}"

exit $?
